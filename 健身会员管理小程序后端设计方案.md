# 健身会员管理小程序后端设计方案

mvn spring-boot:run

## 一、技术架构

### 1. 核心技术栈
- **框架**：Spring Boot 2.7.15
- **ORM框架**：MyBatis Plus 3.5.3.1
- **数据库**：MySQL 8.0.33
- **缓存**：Redis 6.2.13
- **安全框架**：Spring Security 5.7.10 + JWT 0.11.5
- **API文档**：Knife4j 4.4.0 (Swagger 3.0增强版)
- **支付**：微信支付 V3 API
- **工具库**：Lombok 1.18.28, Hutool 5.8.22

### 2. 分层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                       表现层 (Controller)                   │
│  - 处理HTTP请求和响应                                       │
│  - 参数校验和格式转换                                       │
│  - 统一异常处理和响应格式                                   │
├─────────────────────────────────────────────────────────────┤
│                       业务层 (Service)                      │
│  - 实现核心业务逻辑                                         │
│  - 事务管理和并发控制                                       │
│  - 数据校验和业务规则验证                                   │
├─────────────────────────────────────────────────────────────┤
│                       数据层 (Mapper/DAO)                    │
│  - 数据库访问操作                                           │
│  - SQL映射和执行                                            │
│  - 结果集映射                                               │
├─────────────────────────────────────────────────────────────┤
│                       数据持久层 (Database)                  │
│  - MySQL存储结构化数据                                      │
│  - Redis缓存热点数据和会话信息                              │
└─────────────────────────────────────────────────────────────┘
```

### 3. 安全架构

- **认证机制**：JWT Token认证，无状态会话管理
- **授权机制**：基于角色的访问控制(RBAC)，支持接口级权限控制
- **数据安全**：
  - 敏感字段AES加密存储
  - 密码BCrypt哈希处理
  - 接口请求参数签名验证
  - SQL注入防护(MyBatis Plus自带)
  - XSS攻击防护

## 二、数据库设计

### 1. 核心数据表结构

#### 1.1 会员表 (member)
```sql
CREATE TABLE `member` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '会员ID',
  `openid` varchar(100) NOT NULL COMMENT '微信OpenID',
  `unionid` varchar(100) DEFAULT NULL COMMENT '微信UnionID',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar_url` varchar(200) DEFAULT NULL COMMENT '头像URL',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号(加密存储)',
  `gender` tinyint DEFAULT NULL COMMENT '性别(0:未知,1:男,2:女)',
  `birthday` date DEFAULT NULL COMMENT '生日',
  `member_level_id` bigint DEFAULT NULL COMMENT '会员等级ID',
  `points` int DEFAULT '0' COMMENT '积分',
  `balance` decimal(10,2) DEFAULT '0.00' COMMENT '余额',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:正常,0:冻结)',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_member_level_id` (`member_level_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员表';
```

#### 1.2 会员等级表 (member_level)
```sql
CREATE TABLE `member_level` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '等级ID',
  `level_name` varchar(50) NOT NULL COMMENT '等级名称',
  `min_points` int NOT NULL COMMENT '最低积分',
  `max_points` int NOT NULL COMMENT '最高积分',
  `discount_rate` decimal(4,2) DEFAULT '1.00' COMMENT '折扣率',
  `privileges` json DEFAULT NULL COMMENT '等级特权',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_min_max_points` (`min_points`,`max_points`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员等级表';
```

#### 1.3 课程表 (course)
```sql
CREATE TABLE `course` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '课程ID',
  `course_name` varchar(100) NOT NULL COMMENT '课程名称',
  `course_type_id` bigint NOT NULL COMMENT '课程类型ID',
  `coach_id` bigint DEFAULT NULL COMMENT '教练ID',
  `description` text COMMENT '课程描述',
  `duration` int NOT NULL COMMENT '课程时长(分钟)',
  `max_attendees` int NOT NULL COMMENT '最大参与人数',
  `price` decimal(10,2) NOT NULL COMMENT '课程价格',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:正常,0:下架)',
  `cover_image` varchar(200) DEFAULT NULL COMMENT '封面图片',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_course_type_id` (`course_type_id`),
  KEY `idx_coach_id` (`coach_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='课程表';
```

#### 1.4 课程类型表 (course_type)
```sql
CREATE TABLE `course_type` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '类型ID',
  `type_name` varchar(50) NOT NULL COMMENT '类型名称',
  `type_code` varchar(20) NOT NULL COMMENT '类型编码',
  `description` varchar(200) DEFAULT NULL COMMENT '类型描述',
  `sort_order` int DEFAULT '0' COMMENT '排序',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_code` (`type_code`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='课程类型表';
```

#### 1.5 课程排期表 (course_schedule)
```sql
CREATE TABLE `course_schedule` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '排期ID',
  `course_id` bigint NOT NULL COMMENT '课程ID',
  `schedule_date` date NOT NULL COMMENT '排期日期',
  `time_start` time NOT NULL COMMENT '开始时间',
  `time_end` time NOT NULL COMMENT '结束时间',
  `room_id` bigint DEFAULT NULL COMMENT '教室ID',
  `current_attendees` int DEFAULT '0' COMMENT '当前预约人数',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:可预约,2:已满,0:取消)',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_course_id_schedule_date` (`course_id`,`schedule_date`),
  KEY `idx_room_id_schedule_date` (`room_id`,`schedule_date`),
  KEY `idx_schedule_date_time` (`schedule_date`,`time_start`,`time_end`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='课程排期表';
```

#### 1.6 预约表 (booking)
```sql
CREATE TABLE `booking` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '预约ID',
  `member_id` bigint NOT NULL COMMENT '会员ID',
  `schedule_id` bigint NOT NULL COMMENT '排期ID',
  `course_id` bigint NOT NULL COMMENT '课程ID',
  `booking_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '预约时间',
  `booking_status` tinyint DEFAULT '1' COMMENT '预约状态(1:已预约,2:已完成,3:已取消,4:已过期)',
  `attendance_status` tinyint DEFAULT '0' COMMENT '出勤状态(0:未知,1:已出勤,2:未出勤)',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_member_schedule` (`member_id`,`schedule_id`),
  KEY `idx_schedule_id` (`schedule_id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_booking_status` (`booking_status`),
  KEY `idx_member_id_booking_time` (`member_id`,`booking_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预约表';
```

#### 1.7 订单表 (order)
```sql
CREATE TABLE `order` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_no` varchar(50) NOT NULL COMMENT '订单号',
  `member_id` bigint NOT NULL COMMENT '会员ID',
  `total_amount` decimal(10,2) NOT NULL COMMENT '订单总金额',
  `actual_amount` decimal(10,2) NOT NULL COMMENT '实际支付金额',
  `points_deduction` int DEFAULT '0' COMMENT '积分抵扣',
  `coupon_id` bigint DEFAULT NULL COMMENT '优惠券ID',
  `coupon_amount` decimal(10,2) DEFAULT '0.00' COMMENT '优惠券金额',
  `order_type` tinyint NOT NULL COMMENT '订单类型(1:课程预约,2:会员卡购买,3:商品购买)',
  `order_status` tinyint DEFAULT '1' COMMENT '订单状态(1:待支付,2:已支付,3:已取消,4:已完成)',
  `payment_type` tinyint DEFAULT NULL COMMENT '支付方式(1:微信支付,2:余额支付)',
  `payment_time` datetime DEFAULT NULL COMMENT '支付时间',
  `payment_no` varchar(100) DEFAULT NULL COMMENT '支付流水号',
  `refund_status` tinyint DEFAULT '0' COMMENT '退款状态(0:未退款,1:退款中,2:已退款)',
  `refund_amount` decimal(10,2) DEFAULT '0.00' COMMENT '退款金额',
  `refund_time` datetime DEFAULT NULL COMMENT '退款时间',
  `remark` varchar(200) DEFAULT NULL COMMENT '订单备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_member_id` (`member_id`),
  KEY `idx_order_status` (`order_status`),
  KEY `idx_payment_status` (`payment_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

#### 1.8 订单详情表 (order_item)
```sql
CREATE TABLE `order_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '详情ID',
  `order_id` bigint NOT NULL COMMENT '订单ID',
  `item_type` tinyint NOT NULL COMMENT '商品类型(1:课程,2:会员卡,3:实物商品)',
  `item_id` bigint NOT NULL COMMENT '商品ID',
  `item_name` varchar(100) NOT NULL COMMENT '商品名称',
  `quantity` int DEFAULT '1' COMMENT '数量',
  `price` decimal(10,2) NOT NULL COMMENT '单价',
  `total_price` decimal(10,2) NOT NULL COMMENT '总价',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_item_type_item_id` (`item_type`,`item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单详情表';
```

#### 1.9 体测数据表 (body_metrics)
```sql
CREATE TABLE `body_metrics` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `member_id` bigint NOT NULL COMMENT '会员ID',
  `measure_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '测量时间',
  `height` decimal(5,2) DEFAULT NULL COMMENT '身高(cm)',
  `weight` decimal(5,2) DEFAULT NULL COMMENT '体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `body_fat_rate` decimal(4,2) DEFAULT NULL COMMENT '体脂率(%)',
  `muscle_mass` decimal(5,2) DEFAULT NULL COMMENT '肌肉量(kg)',
  `visceral_fat` int DEFAULT NULL COMMENT '内脏脂肪等级',
  `remarks` varchar(200) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_member_id` (`member_id`),
  KEY `idx_measure_time` (`measure_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='体测数据表';
```

#### 1.10 教练表 (coach)
```sql
CREATE TABLE `coach` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '教练ID',
  `coach_name` varchar(50) NOT NULL COMMENT '教练姓名',
  `avatar_url` varchar(200) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号(加密存储)',
  `specialty` varchar(100) DEFAULT NULL COMMENT '专长',
  `introduction` text COMMENT '教练介绍',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:在职,0:离职)',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='教练表';
```

#### 1.11 教室表 (room)
```sql
CREATE TABLE `room` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '教室ID',
  `room_name` varchar(50) NOT NULL COMMENT '教室名称',
  `capacity` int NOT NULL COMMENT '容纳人数',
  `description` varchar(200) DEFAULT NULL COMMENT '教室描述',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:可用,0:不可用)',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='教室表';
```

#### 1.12 积分记录表 (points_record)
```sql
CREATE TABLE `points_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `member_id` bigint NOT NULL COMMENT '会员ID',
  `points` int NOT NULL COMMENT '积分(正数为增加,负数为减少)',
  `points_type` tinyint NOT NULL COMMENT '积分类型(1:签到,2:消费,3:活动奖励,4:兑换)',
  `source_id` bigint DEFAULT NULL COMMENT '来源ID(如订单ID)',
  `description` varchar(200) NOT NULL COMMENT '积分描述',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_member_id` (`member_id`),
  KEY `idx_points_type` (`points_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分记录表';
```

### 2. 索引优化策略

1. **课程预约冲突检测**：
   - 为course_schedule表创建复合索引：`idx_room_id_schedule_date_time`(room_id, schedule_date, time_start, time_end)
   - 用于快速检测同一教室在同一时间段的课程冲突

2. **会员查询优化**：
   - 为member表创建索引：`idx_phone`(phone)
   - 为member表创建索引：`idx_member_level_id`(member_level_id)

3. **预约查询优化**：
   - 为booking表创建复合索引：`idx_member_id_schedule_id`(member_id, schedule_id)
   - 防止重复预约的唯一约束

4. **订单查询优化**：
   - 为order表创建索引：`idx_member_id_order_status`(member_id, order_status)
   - 为order表创建索引：`idx_order_no`(order_no)

### 3. 数据安全设计

1. **敏感字段加密**：
   - 手机号(phone)使用AES加密存储
   - 实现方式：使用MyBatis Plus的TypeHandler机制

2. **密码安全**：
   - 后台管理员密码使用BCrypt哈希处理
   - 会员密码（如需）使用同样方式

3. **数据脱敏**：
   - 支付相关信息脱敏处理
   - API返回手机号等敏感信息时进行脱敏

## 三、API接口设计

### 1. 接口规范

- **RESTful风格**：使用GET/POST/PUT/DELETE等HTTP方法
- **统一响应格式**：
  ```json
  {
    "code": 200,              // 状态码(200成功,其他失败)
    "message": "success",     // 响应消息
    "data": {},              // 响应数据
    "timestamp": 1620000000  // 时间戳
  }
  ```
- **错误处理**：统一异常处理器，包含业务异常、系统异常等
- **分页规范**：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": {
      "records": [],         // 数据列表
      "total": 100,          // 总记录数
      "size": 10,            // 每页大小
      "current": 1,          // 当前页码
      "pages": 10            // 总页数
    }
  }
  ```

### 2. 会员管理模块API

#### 2.1 会员认证
- **登录接口**：`POST /api/member/login`
  - 参数：`{"code": "微信登录code"}`
  - 返回：JWT Token和会员信息

- **获取会员信息**：`GET /api/member/info`
  - 认证：JWT Token
  - 返回：会员详细信息

- **更新会员信息**：`PUT /api/member/info`
  - 参数：会员信息JSON
  - 返回：更新结果

#### 2.2 会员等级
- **获取会员等级列表**：`GET /api/member/level/list`
  - 返回：所有会员等级

- **获取当前会员等级**：`GET /api/member/level/current`
  - 返回：当前会员等级信息

#### 2.3 积分管理
- **获取积分记录**：`GET /api/member/points/records`
  - 参数：分页参数
  - 返回：积分记录列表

- **积分兑换**：`POST /api/member/points/exchange`
  - 参数：`{"goodsId": "商品ID", "quantity": 1}`
  - 返回：兑换结果

### 3. 课程管理模块API

#### 3.1 课程列表
- **获取课程分类**：`GET /api/course/categories`
  - 返回：课程分类列表

- **获取课程列表**：`GET /api/course/list`
  - 参数：`categoryId`, `keyword`, `page`, `size`
  - 返回：课程分页列表

- **获取课程详情**：`GET /api/course/{id}`
  - 返回：课程详细信息

#### 3.2 课程排期
- **获取课程排期**：`GET /api/course/schedule`
  - 参数：`courseId`, `startDate`, `endDate`
  - 返回：课程排期列表

- **获取排期详情**：`GET /api/course/schedule/{id}`
  - 返回：排期详细信息

### 4. 预约管理模块API

#### 4.1 预约操作
- **创建预约**：`POST /api/booking`
  - 参数：`{"scheduleId": "排期ID"}`
  - 返回：预约结果

- **取消预约**：`PUT /api/booking/{id}/cancel`
  - 返回：取消结果

- **获取我的预约**：`GET /api/booking/my`
  - 参数：`status`, `page`, `size`
  - 返回：我的预约列表

- **获取预约详情**：`GET /api/booking/{id}`
  - 返回：预约详细信息

#### 4.2 预约统计
- **获取预约统计**：`GET /api/booking/statistics`
  - 返回：预约统计数据

### 5. 体测数据模块API

#### 5.1 体测记录
- **创建体测记录**：`POST /api/body-metrics`
  - 参数：体测数据JSON
  - 返回：创建结果

- **获取体测记录**：`GET /api/body-metrics`
  - 参数：分页参数
  - 返回：体测记录列表

- **获取体测趋势**：`GET /api/body-metrics/trend`
  - 参数：`metricType`, `startDate`, `endDate`
  - 返回：体测指标趋势数据

### 6. 支付订单模块API

#### 6.1 订单管理
- **创建订单**：`POST /api/order`
  - 参数：订单信息JSON
  - 返回：订单创建结果

- **获取订单列表**：`GET /api/order/list`
  - 参数：`status`, `page`, `size`
  - 返回：订单列表

- **获取订单详情**：`GET /api/order/{id}`
  - 返回：订单详细信息

- **取消订单**：`PUT /api/order/{id}/cancel`
  - 返回：取消结果

#### 6.2 支付相关
- **微信支付**：`POST /api/pay/wx-pay`
  - 参数：`{"orderId": "订单ID"}`
  - 返回：微信支付参数

- **支付回调**：`POST /api/pay/wx-callback`
  - 微信支付异步通知接口

- **余额支付**：`POST /api/pay/balance`
  - 参数：`{"orderId": "订单ID"}`
  - 返回：支付结果

### 7. 营销裂变模块API

#### 7.1 邀请好友
- **获取邀请码**：`GET /api/marketing/invite-code`
  - 返回：邀请码信息

- **邀请记录**：`GET /api/marketing/invite-records`
  - 参数：分页参数
  - 返回：邀请记录列表

#### 7.2 活动管理
- **获取活动列表**：`GET /api/marketing/activities`
  - 返回：活动列表

- **获取活动详情**：`GET /api/marketing/activity/{id}`
  - 返回：活动详细信息

## 四、业务逻辑实现

### 1. 核心业务流程

#### 1.1 课程预约流程

```
会员选择课程 → 选择排期 → 检查预约条件 → 创建预约记录 → 更新排期人数 → 生成订单 → 支付 → 预约成功
```

**并发控制实现**：
- 使用MySQL悲观锁：`SELECT ... FOR UPDATE`锁定排期记录
- 使用Redis分布式锁：防止同一用户同时发起多次预约
- 双重检查：预约前检查人数，预约后再次验证

**伪代码实现**：
```java
@Transactional(rollbackFor = Exception.class)
public Booking createBooking(Long memberId, Long scheduleId) {
    // 1. 检查排期是否存在且可预约
    CourseSchedule schedule = courseScheduleMapper.selectById(scheduleId);
    if (schedule == null || schedule.getStatus() != 1) {
        throw new BusinessException("排期不存在或不可预约");
    }
    
    // 2. 检查是否已预约
    Booking existingBooking = bookingMapper.selectOne(
        new QueryWrapper<Booking>()
            .eq("member_id", memberId)
            .eq("schedule_id", scheduleId)
    );
    if (existingBooking != null) {
        throw new BusinessException("您已预约该课程");
    }
    
    // 3. 检查人数是否已满
    if (schedule.getCurrentAttendees() >= schedule.getMaxAttendees()) {
        throw new BusinessException("该课程已约满");
    }
    
    // 4. 使用Redis分布式锁防止并发预约
    String lockKey = "booking_lock:" + scheduleId;
    RLock lock = redissonClient.getLock(lockKey);
    try {
        if (lock.tryLock(10, 5, TimeUnit.SECONDS)) {
            // 5. 再次检查人数（双重检查）
            schedule = courseScheduleMapper.selectById(scheduleId);
            if (schedule.getCurrentAttendees() >= schedule.getMaxAttendees()) {
                throw new BusinessException("该课程已约满");
            }
            
            // 6. 创建预约记录
            Booking booking = new Booking();
            booking.setMemberId(memberId);
            booking.setScheduleId(scheduleId);
            booking.setCourseId(schedule.getCourseId());
            booking.setBookingStatus(1); // 已预约
            bookingMapper.insert(booking);
            
            // 7. 更新排期人数
            courseScheduleMapper.updateById(
                new CourseSchedule()
                    .setId(scheduleId)
                    .setCurrentAttendees(schedule.getCurrentAttendees() + 1)
                    .setStatus(schedule.getCurrentAttendees() + 1 >= schedule.getMaxAttendees() ? 2 : 1)
            );
            
            return booking;
        } else {
            throw new BusinessException("预约人数过多，请稍后重试");
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
        throw new BusinessException("预约失败，请稍后重试");
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

#### 1.2 微信支付对接流程

```
生成订单 → 调用微信统一下单API → 获取预支付参数 → 小程序调起支付 → 支付结果通知 → 更新订单状态
```

**支付回调处理**：
- 验证签名
- 处理重复通知
- 更新订单状态
- 记录支付日志
- 处理业务逻辑（如会员等级升级、积分增加等）

### 2. 数据一致性保障

1. **事务管理**：
   - 使用Spring @Transactional注解管理事务
   - 设置合理的事务隔离级别
   - 配置事务超时时间

2. **定时任务补偿**：
   - 订单超时取消任务
   - 预约过期处理任务
   - 数据一致性校验任务

3. **消息队列**：
   - 异步处理非核心业务（如积分发放、消息通知等）
   - 提高系统响应速度

## 五、开发实施计划

### 1. 实施顺序

1. **基础框架搭建**：
   - Spring Boot项目初始化
   - 数据库配置
   - 安全框架集成
   - API文档配置

2. **会员模块开发**：
   - 会员表设计与实现
   - 会员认证与授权
   - 会员信息管理
   - 会员等级管理

3. **课程模块开发**：
   - 课程表设计与实现
   - 课程类型管理
   - 课程信息管理
   - 课程排期管理

4. **预约模块开发**：
   - 预约表设计与实现
   - 预约流程实现
   - 并发控制实现
   - 预约统计功能

5. **支付模块开发**：
   - 订单表设计与实现
   - 微信支付对接
   - 余额支付实现
   - 订单管理功能

6. **营销模块开发**：
   - 积分管理
   - 邀请裂变功能
   - 活动管理

### 2. 开发建议

1. **代码规范**：
   - 使用阿里巴巴Java开发手册
   - 统一命名规范
   - 完善代码注释

2. **测试策略**：
   - 单元测试：覆盖核心业务逻辑
   - 集成测试：验证模块间集成
   - 性能测试：验证并发处理能力
   - 安全测试：验证安全防护能力

3. **部署建议**：
   - 使用Docker容器化部署
   - 配置CI/CD流水线
   - 实现灰度发布
   - 配置监控告警

4. **运维建议**：
   - 配置日志收集系统
   - 实现性能监控
   - 定期备份数据
   - 制定应急预案

## 六、总结

本设计方案提供了一个完整的健身会员管理小程序后端解决方案，覆盖了技术架构、数据库设计、API接口和核心业务逻辑。方案采用了现代化的技术栈和架构设计，注重性能优化、数据安全和用户体验。

在实施过程中，建议按照设计方案的实施顺序进行开发，重点关注课程预约并发控制、微信支付对接和数据一致性保障等关键环节。同时，建议加强测试和监控，确保系统的稳定性和安全性。

通过本方案的实施，可以为健身会员提供便捷、高效、安全的在线服务，提升用户体验和运营效率。